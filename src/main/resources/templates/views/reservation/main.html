<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="~{/layout/defaultLayout :: setContent(~{this::content})}">
    <th:block th:fragment="content">
        <!-- 개별 css-->
        <link rel="stylesheet" th:href="@{/css/page.css}">

        <!-- jquery-validation -->
        <script th:src="@{/plugins/jquery-validation/jquery.validate.min.js}"></script>
        <script th:src="@{/plugins/jquery-validation/additional-methods.min.js}"></script>
        <script th:src="@{/js/common/validator.js}"></script>

        <script th:src="@{/js/timeTable.js}" defer></script>
        <link rel="stylesheet" th:href="@{/css/timeTable.css}">

        <!-- modal -->
        <script th:src="@{/js/modal.js}"></script>
        <link rel="stylesheet" th:href="@{/css/modal.css}">

        <style>
            .container {
                left: 50%;
                width: 100%;
                transform: translateX(-50%);
            }

            .datepicker::placeholder {
                color: #999999 !important;
                text-align: center;
            }

            .datepicker.flatpickr-input {
                position: relative;
            }

            input:read-only {
                background-color: #dddddd;
            }

            #timetableDatepicker {
                border: none;
                background-color: #ffffff;
                min-width: 1px;
                height: 20px;
                padding: 0;
                width: 102px;
                text-align: center;
            }

            .schedule-cell {
                border: 1px solid #ccc;
                text-align: center;
                font-size: 12px;
                padding: 4px;
            }

            .type_list {
                font-size: 14px !important;
                font-weight: 400;
            }

            .showSchedule {
                cursor: pointer;
            }
            .showSchedule:hover {
                background-color: #1e6ceb;
                color: #fff;
            }

            .tableStyle.listT td {
                font-size: 14px !important;
            }

            .allday-cell {
                text-align: center;
                padding: 8px 4px;   /* 상하 8px, 좌우 4px */
                line-height: 2.5;   /* 줄 간격 */
            }

            .select_readonly {
                pointer-events: none;
                background-color: #dddddd;
            }

            .customerDetail, .reservationDetail {
                cursor: pointer;
            }
        </style>

        <div class="info_calendar">
            <div class="left_area">
                <div class="customer_info_btn">
                    <a href="#" class="page_btn active">기존 고객 정보</a>
                    <a href="/reservation/register" class="page_btn">신규 고객 등록</a>
                </div>

                <div class="info_wrap">
                    <div class="search_style_1 mt-20px">
                        <h3 class="title">고객 검색</h3>
                        <div class="inner_bg inner_style_1">
                            <h4 class="inner_title">고객명</h4>
                            <input type="text" id="searchInput">
                            <button type="button" class="search_btn" id="searchButton" style="background:#1e6ceb">
                                <img th:src="@{/images/icon/search_w.png}" alt="검색 아이콘" class="search_icon">
                            </button>
                            <button type="button" class="search_btn" id="initButton" style="background:#ffffff">
                                <img th:src="@{/images/icon/reset.png}" alt="검색 아이콘" class="search_icon">
                            </button>
                        </div>
                    </div>
                    <div id="customerListWrap" class="search_style_1 mt-20px scroll-box">
                        <div class="top_line flex between">
                            <h3 class="title">고객 목록</h3>
                        </div>
                        <table class="tableStyle listT">
                            <thead>
                            <colgroup>
                                <col style="width: 20%">
                                <col style="width: 25%">
                                <col style="width: 30%">
                                <col style="width: 25%">
                            </colgroup>
                            <tr class="title_tr">
                                <th>구분</th>
                                <th>이름</th>
                                <th>휴대전화</th>
                                <th>상담일</th>
                            </tr>
                            </thead>
                            <tbody id="customerListBody">
                            </tbody>
                        </table>
                    </div>
                    <div id="customerDetailWrap" class="search_style_1 mt-20px scroll-box">
                        <form id="dataForm">
                            <input type="hidden" id="reservationId" name="reservationId">
                            <div class="top_line flex between">
                                <h3 class="title">고객 정보</h3>
                                <button type="button" class="btnColor_1" id="registerButton" style="display: none;">저장</button>
                            </div>
                            <div class="inner_bg inner_style_1 column">
                                <div class="one-line mb-5px">
                                    <div class="half-line">
                                        <h4 class="inner_title">고객명1</h4>
                                        <input type="text" name="name1" id="name1" maxlength="10" placeholder="10자 이내 입력">
                                    </div>
                                    <div class="half-line">
                                        <h4 class="inner_title">연락처1</h4>
                                        <input type="tel" name="mobile1" id="mobile1" maxlength="11" placeholder="숫자만 입력">
                                    </div>
                                </div>
                                <div class="one-line">
                                    <div class="half-line">
                                        <h4 class="inner_title">고객명2</h4>
                                        <input type="text" name="name2" id="name2" maxlength="10" placeholder="10자 이내 입력">
                                    </div>
                                    <div class="half-line">
                                        <h4 class="inner_title">연락처2</h4>
                                        <input type="tel" name="mobile2" id="mobile2" maxlength="11" placeholder="숫자만 입력">
                                    </div>
                                </div>
                            </div>
                            <div class="inner_bg inner_style_1 column mt-20px">
                                <div class="one-line mb-5px">
                                    <div class="half-line">
                                        <h4 class="inner_title">촬영일</h4>
                                        <div class="input-with-icon">
                                            <input type="text" name="photoDate" id="photoDate" class="datepicker" placeholder="날짜선택" readonly>
                                        </div>
                                    </div>
                                    <div class="half-line">
                                        <h4 class="inner_title">촬영장소</h4>
                                        <input type="text" name="photoPlace" id="photoPlace" maxlength="20" placeholder="20자 이내 입력">
                                    </div>
                                </div>
                                <div class="one-line">
                                    <div class="half-line">
                                        <h4 class="inner_title">본식일</h4>
                                        <div class="input-with-icon">
                                            <input type="text" name="weddingDate" id="weddingDate" class="datepicker" placeholder="날짜선택" readonly>
                                        </div>
                                    </div>
                                    <div class="half-line">
                                        <h4 class="inner_title">예식장소</h4>
                                        <input type="text" name="weddingPlace" id="weddingPlace" maxlength="20" placeholder="20자 이내 입력">
                                    </div>
                                </div>
                            </div>

                            <div class="top_line flex between mt-20px">
                                <h3 class="title">예약 정보</h3>
                            </div>
                            <div class="inner_bg inner_style_1 column">
                                <div class="one-line mb-5px w_100">
                                    <div class="half-line">
                                        <h4 class="inner_title">예약담당</h4>
                                        <select name="reservationManager" id="reservationManager" class="t-center">
                                            <option th:each='employee: ${employeeList}' th:value="${employee.userId}" th:text="${employee.name}"></option>
                                        </select>
                                    </div>
                                    <div class="half-line">
                                        <h4 class="inner_title">예약구분</h4>
                                        <select name="type" id="type" class="t-center">
                                            <option value="1" selected>맞춤예약</option>
                                            <option value="2" th:text="${siteEnvDto.typeName2}"></option>
                                            <option value="3" th:text="${siteEnvDto.typeName3}"></option>
                                            <option value="4" th:text="${siteEnvDto.typeName4}"></option>
                                            <option value="5" th:text="${siteEnvDto.typeName5}"></option>
                                            <option value="6" th:text="${siteEnvDto.typeName6}"></option>
                                        </select>
                                    </div>
                                </div>
                                <div class="one-line mb-5px w_100">
                                    <div class="half-line">
                                        <h4 class="inner_title">상담담당</h4>
                                        <select name="consultingManager" id="consultingManager" class="t-center">
                                            <option value="" selected>-- 선택 --</option>
                                            <option th:each='employee: ${employeeList}' th:value="${employee.userId}" th:text="${employee.name}"></option>
                                        </select>
                                    </div>
                                    <div class="half-line">
                                        <h4 class="inner_title">예약날짜</h4>
                                        <div class="input-with-icon">
                                            <input type="text" name="consultingDate" id="consultingDate" class="datepicker reservationDatetime" placeholder="날짜선택" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="one-line">
                                    <div class="one-line">
                                        <h4 class="inner_title">예약시간</h4>
                                        <label for="isAllday">
                                            <input type="checkbox" name="isAllday" id="isAllday" value="true">
                                            미정
                                        </label>
                                        <select class="reservationDatetime" name="consultingHour" id="consultingHour">
                                            <option value="">선택</option>
                                            <option value="09">09</option>
                                            <option value="10">10</option>
                                            <option value="11">11</option>
                                            <option value="12">12</option>
                                            <option value="13">13</option>
                                            <option value="14">14</option>
                                            <option value="15">15</option>
                                            <option value="16">16</option>
                                            <option value="17">17</option>
                                            <option value="18">18</option>
                                            <option value="19">19</option>
                                            <option value="20">20</option>
                                            <option value="21">21</option>
                                            <option value="22">22</option>
                                        </select>
                                        시&nbsp;
                                        <select class="reservationDatetime" name="consultingMinute" id="consultingMinute">
                                            <option value="">선택</option>
                                            <option value="00">00</option>
                                            <option value="10">10</option>
                                            <option value="20">20</option>
                                            <option value="30">30</option>
                                            <option value="40">40</option>
                                            <option value="50">50</option>
                                        </select>
                                        분
                                    </div>
                                </div>
                            </div>
                            <ul class="inner_style_2 mt-20px">
                                <li><span class="border-bottom" id="resultName">OOO</span> 고객님</li>
                                <li>
                                    <span class="border-bottom" id="resultDatetime">XXXX년 XX월 XX일 XX시 XX분</span>
                                </li>
                                <li>
                                    <span class="border-bottom" id="resultManager">OOO</span> 담당자와 상담 진행 예정입니다.
                                </li>
                            </ul>
                            <div class="inner_style_3 mt-20px">
                                <textarea class="textarea" id="memo" name="memo" placeholder="고객 특이사항"></textarea>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="right_area">
                <div class="flex between">
                    <ul class="date-line flex flex-start align-center">
                        <li class="type_list" th:style="${'color: ' + siteEnvDto.typeColor1}">맞춤상담</li>
                        <li class="type_list" th:style="${'color: ' + siteEnvDto.typeColor2}" th:text="${siteEnvDto.typeName2}">항목2</li>
                        <li class="type_list" th:style="${'color: ' + siteEnvDto.typeColor3}" th:text="${siteEnvDto.typeName3}">항목3</li>
                        <li class="type_list" th:style="${'color: ' + siteEnvDto.typeColor4}" th:text="${siteEnvDto.typeName4}">항목4</li>
                        <li class="type_list" th:style="${'color: ' + siteEnvDto.typeColor5}" th:text="${siteEnvDto.typeName5}">항목5</li>
                        <li class="type_list" th:style="${'color: ' + siteEnvDto.typeColor6}" th:text="${siteEnvDto.typeName6}">항목6</li>
                    </ul>
                    <div class="date-line flex flex-end align-center">
                        <button class="prev-btn btn" id="prevBtn"> < </button>
                        <input type="text" class="timetable_datepicker" id="timetableDatepicker" readonly>
                        <button class="next-btn btn" id="nextBtn"> > </button>
                    </div>
                </div>

                <div class="schedule-container">
                    <table class="custom-schedule-table" id="custom-schedule-table">
                        <thead>
                        <tr></tr>
                        </thead>
                        <tbody id="scheduleBody">
                        <!-- JS로 생성 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </th:block>
</th:block>

<div class="modal_window modal_style" id="reservationDetailModal">
    <div class="inner_box">
        <form id="reservationDetailForm">
            <input type="hidden" name="reservationIdModal" id="reservationIdModal">
            <input type="hidden" name="consultingMangerIdModal" id="consultingMangerIdModal">
            <h2 class="title">예약 정보</h2>
            <div class="data_box">
                <div>
                    담당자 : <span id="reservationModalPic"></span>
                </div>
                <div>
                    고객명 : <span id="reservationModalCustomer"></span>
                </div>
                <div>
                    컨설팅 : <span id="reservationModalPartner"></span>
                </div>
                <div>
                    날짜
                    <label for="isAlldayModal">
                        <input type="checkbox" name="isAlldayModal" id="isAlldayModal" value="true">
                        미정
                    </label>
                    <input type="text" id="reservationModalConsultingDate" name="reservationModalConsultingDate" readonly>
                    <select class="reservationDatetime" name="consultingHourModal" id="consultingHourModal">
                        <option value="">선택</option>
                        <option value="09">09</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                    </select>
                    시&nbsp;
                    <select class="reservationDatetime" name="consultingMinuteModal" id="consultingMinuteModal">
                        <option value="">선택</option>
                        <option value="00">00</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="30">30</option>
                        <option value="40">40</option>
                        <option value="50">50</option>
                    </select>
                    분
                </div>
                <div>
                    구분
                    <select name="reservationModalType" id="reservationModalType" class="t-center">
                        <option value="1" selected>맞춤예약</option>
                        <option value="2" th:text="${siteEnvDto.typeName2}"></option>
                        <option value="3" th:text="${siteEnvDto.typeName3}"></option>
                        <option value="4" th:text="${siteEnvDto.typeName4}"></option>
                        <option value="5" th:text="${siteEnvDto.typeName5}"></option>
                        <option value="6" th:text="${siteEnvDto.typeName6}"></option>
                    </select>
                </div>
                <div>
                    내용
                    <textarea name="reservationModalMemo" id="reservationModalMemo"></textarea>
                </div>
                <div>
                    계약여부
                    <select name="reservationModalContract" id="reservationModalContract" class="t-center">
                        <option value="0">미해당</option>
                        <option value="1">계약</option>
                        <option value="2">투어</option>
                        <option value="3">취소</option>
                    </select>
                </div>
            </div>
            <div class="btn_wrap center mt-40px">
                <div class="innerBtn_box">
                    <button type="button" id="updateButton" class="btnColor_1 btn_2">저장</button>
                    <button type="button" id="completeButton" class="btn_2">상담완료</button>
                    <button type="button" class="closeModalButton btn_2" data-label="#reservationDetailModal" onclick="closeModal($(this).data('label'), initReservationDetailModal)">닫기</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script th:inline="javascript">
    let siteEnv = [[${siteEnvDto}]];

    let todayString = getToday('YYYY-MM-DD');
    let momentDate = moment(todayString);

    const fp = standardPickerWithMinDate($('.datepicker'));
    const fp1 = standardPicker($('#reservationModalConsultingDate'));

    $(document).ready(function () {

        // 금일 타임 테이블 로드
        getCustomerList('', todayString);
        renderTimeTable('custom-schedule-table', todayString);

        $('#searchInput').focus();

        $('#customerDetailWrap').hide();
    });

    $(document).on('click', '#isAllday', function () {
        if ($(this).is(':checked')) {
            $('#consultingHour').val('');
            $('#consultingMinute').val('');
            setReadonlySelect($('#consultingHour'), true);
            setReadonlySelect($('#consultingMinute'), true);
        } else {
            setReadonlySelect($('#consultingHour'), false);
            setReadonlySelect($('#consultingMinute'), false);
        }
    });

    $(document).on('click', '#isAlldayModal', function () {
        if ($(this).is(':checked')) {
            $('#consultingHourModal').val('');
            $('#consultingMinuteModal').val('');
            setReadonlySelect($('#consultingHourModal'), true);
            setReadonlySelect($('#consultingMinuteModal'), true);
        } else {
            setReadonlySelect($('#consultingHourModal'), false);
            setReadonlySelect($('#consultingMinuteModal'), false);
        }
    });

    $(document).on('change', '#reservationModalConsultingDate', function () {
        // const isVisible = $('#reservationDetailModal').is(':visible');
        // const date = $(this).val();
        // if (isVisible && !isEmpty(date)) {
        //     renderTimeTable('custom-schedule-table', date);
        // }
    });

    function setReadonlySelect($obj, state) {
        if (state) {
            $obj.addClass('select_readonly');
        } else {
            $obj.removeClass('select_readonly');
        }
    }

    function renderCustomerList(reservationList) {
        $('#customerListBody').empty();
        if (reservationList.length == 0) {
            $('#customerListBody').append(`
            <tr>
                <td colspan="5">상담 고객이 존재하지 않습니다.</td>
            </tr>
            `);
        } else {
            reservationList.forEach(function (reservation) {
                const name = isEmpty(reservation.name2) ? reservation.name1 : `${reservation.name1}<br>(${reservation.name2})`
                const mobile = isEmpty(reservation.name2) ? addDashToMobileNumber(reservation.mobile1) : `${addDashToMobileNumber(reservation.mobile1)}<br>(${addDashToMobileNumber(reservation.mobile2)})`
                $('#customerListBody').append(`
                <tr class="showSchedule" data-reservationid="${reservation.reservationId}">
                    <td>${reservation.reservationTypeString}</td>
                    <td>${name}</td>
                    <td>${mobile}</td>
                    <td>${reservation.consultingDate == null ? '' : reservation.consultingDate}</td>
                </tr>
                `);
            });
        }

        $('#customerDetailWrap').hide();
        $('#customerListWrap').show();
    }

    function setCustomerData(data) {
        $('#reservationId').val(data.reservationId);

        $('#name1').val(data.name1);
        $('#mobile1').val(data.mobile1);
        $('#name2').val(data.name2);
        $('#mobile2').val(data.mobile2);

        $('#photoDate').val(data.photoDate);
        $('#photoPlace').val(data.photoPlace);
        $('#weddingDate').val(data.weddingDate);
        $('#weddingPlace').val(data.weddingPlace);

        $('#reservationManager').val(data.reservationManagerId);
        $('#type').val(data.type);
        $('#consultingManager').val(data.consultingManagerId);
        $('#consultingDate').val(data.consultingDate);
        $('#consultingHour').val(data.consultingHour);
        $('#consultingMinute').val(data.consultingMinute);

        $('#memo').val(data.memo);
        $('#customerDetailWrap').show();
        $('#customerListWrap').hide();
        $('#isAllday').prop('checked', data.isAllday);
        setReadonlySelect($('#consultingHour'), data.isAllday);
        setReadonlySelect($('#consultingMinute'), data.isAllday);
    }

    function setReservationText() {
        // 이름
        let name1 = $('#name1').val();
        if (isEmpty(name1)) {
            name1 = 'OOO'
        }
        $('#resultName').text(name1);

        // 날짜
        let dateArray = isEmpty($('#consultingDate').val()) ? 'XXXX-XX-XX'.split('-') : $('#consultingDate').val().split('-');
        let year = dateArray[0];
        let month = dateArray[1];
        let date = dateArray[2];
        let hour = isEmpty($('#consultingHour').val()) ? 'XX' : $('#consultingHour').val();
        let minute = isEmpty($('#consultingMinute').val()) ? 'XX' : $('#consultingMinute').val();

        $('#resultDatetime').text(`${year}년 ${month}월 ${date}일 ${hour}시 ${minute}분`);

        // 담당자 이름
        let consultManager = $('#consultingManager option:selected').text();
        if (isEmpty(consultManager)) {
            consultManager = 'OOO'
        }
        $('#resultManager').text(consultManager);
    }

    function getCustomerList(searchKeyword, searchDate) {
        showLoadingImage();

        callService(
            "GET"
            , `/reservation/customer/list?searchKeyword=${searchKeyword}&searchDate=${searchDate}`
            , {}
            , function (response) {
                renderCustomerList(response.result);
            }
        );
    }

    function scrollToHour(hour) {
        const target = document.getElementById("time-" + String(hour).padStart(2, '0'));
        if (target) {
            target.scrollIntoView({ behavior: "smooth", block: "start" });
        }
    }

    $(function () {
        callValidationFormService(
            $('#dataForm')
            , {
                name1: validationObject.customerName1.rules
                , mobile1: validationObject.customerMobile1.rules
                , name2: validationObject.customerName2.rules
                , mobile2: validationObject.customerMobile2.rules
                , reservationManager: validationObject.reservationManager.rules
                , consultingManager: validationObject.consultingManager.rules
                , consultingDate: validationObject.consultingDate.rules
                , consultingHour: validationObject.consultingHour.rules
                , consultingMinute: validationObject.consultingMinute.rules
            }
            , {
                name1: validationObject.customerName1.message
                , mobile1: validationObject.customerMobile1.message
                , name2: validationObject.customerName2.message
                , mobile2: validationObject.customerMobile2.message
                , reservationManager: validationObject.reservationManager.message
                , consultingManager: validationObject.consultingManager.message
                , consultingDate: validationObject.consultingDate.message
                , consultingHour: validationObject.consultingHour.message
                , consultingMinute: validationObject.consultingMinute.message
            }
            , function (form) {
                if (doubleClick.isDouble()) {
                    return false;
                }

                if (!confirm("저장하시겠습니까?")) {
                    doubleClick.initFlag();
                    return;
                }

                showLoadingImage();

                callService(
                    "POST"
                    , "/reservation/update"
                    , JSON.stringify(convertFormToJSON(form))
                    , function (response) {
                        alert(response.message);
                        initTimeTable('custom-schedule-table');
                        renderTimeTable('custom-schedule-table', $('#consultingDate').val());
                    }
                );
            }
        );
    });

    $(document).on('click', '#registerButton', function() {
        $('#dataForm').submit();
    });

    let isSearching = false;

    $(document).on('keydown', '#searchInput', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault();

            if (isSearching) return;
            isSearching = true;

            $('#searchButton').trigger('click');

            // 500ms 뒤에 다시 허용
            setTimeout(() => isSearching = false, 500);
        }
    });

    $(document).on('click', '#searchButton', function () {
        const inputValue = $('#searchInput').val();

        if (isEmpty(inputValue)) {
            alert('검색할 고객명을 입력해주세요');
            return;
        }

        getCustomerList(inputValue, '');
    });

    $(document).on('click', '#initButton', function () {
        location.replace('/reservation/main');
    });

    $(document).on('click', '.showSchedule', function () {
        const reservationId = $(this).data('reservationid');

        showLoadingImage();

        callService(
            "GET"
            , "/reservation/customer/detail?reservationId=" + reservationId
            , {}
            , function (response) {
                if (response.success) {
                    setCustomerData(response.result);

                    $('#registerButton').show();
                    setReservationText();

                    momentDate = moment(response.result.consultingDate);

                    initTimeTable('custom-schedule-table');
                    renderTimeTable('custom-schedule-table', getDatetimeString(momentDate, 'YYYY-MM-DD'));

                    if (!response.result.isAllday) {
                        setTimeout(() => {
                            scrollToHour(response.result.consultingHour);
                        }, 100);
                    }
                } else {
                    alert(`${response.message}`);
                }
            }
        );
    });

    $(document).on('change', '#consultingDate, #timetableDatepicker', function() {
        momentDate = moment($(this).val());

        initTimeTable('custom-schedule-table');
        renderTimeTable('custom-schedule-table', getDatetimeString(momentDate, $(this).val()));
    });

    $(document).on('click', '#prevBtn', function() {
        momentDate = momentDate.subtract(1, 'days');

        initTimeTable('custom-schedule-table');
        renderTimeTable('custom-schedule-table', getDatetimeString(momentDate, 'YYYY-MM-DD'));
    });

    $(document).on('click', '#nextBtn', function() {
        momentDate = momentDate.add(1, 'days');

        initTimeTable('custom-schedule-table');
        renderTimeTable('custom-schedule-table', getDatetimeString(momentDate, 'YYYY-MM-DD'));
    });

    // 예약 안내 멘트 관련
    $(document).on('focusout', '#name1', function() {
        setReservationText();
    });

    $(document).on('change', '.reservationDatetime', function() {
        setReservationText();
    });

    $(document).on('change', '#consultingManager', function() {
        setReservationText();
    });

    $(document).on('click', '.customerDetail', function() {
        window.open(`/reservation/popup/customer/detail?customerId=${$(this).data('customerid')}`, "ImageViewer"
            , `left=0, top=0, width=${screen.availWidth}, height=${screen.availHeight} fullscreen=yes, status=no, menubar=no, toolbar=no, resizable=no`
        );
    });

    $(document).on('click', '.reservationDetail', function() {
        if (doubleClick.isDouble()) {
            return false;
        }

        callLazyService(
            "GET"
            , `/reservation/detail?reservationId=${$(this).data('reservationid')}`
            , {}
            , function (response) {
                if (response.success) {
                    openModal('#reservationDetailModal', initReservationDetailModal);
                    setReservationDetailInfo(response.result);
                    if (response.result.completed) {
                        $('#updateButton').hide()
                    }
                    if (response.result.type == 1 || response.result.completed) {
                        $('#completeButton').hide();
                    }
                } else {
                    alert(response.message);
                }
            }
        );
    });

    $(document).on('click', '#updateButton', function() {
        if (doubleClick.isDouble()) {
            return;
        }

        if (!confirm('예약 정보를 저장하시겠습니까?')) {
            doubleClick.initFlag();
            return;
        }

        showLoadingImage();

        callService(
            "POST"
            , "/reservation/detail/update"
            , JSON.stringify(convertFormToJSON($('#reservationDetailForm')))
            , function (response) {
                alert(`${response.message}`);
            }
        );
    });

    $(document).on('click', '#completeButton', function() {
        if (doubleClick.isDouble()) {
            return;
        }

        if (!confirm('완료 처리하시겠습니까?')) {
            doubleClick.initFlag();
            return;
        }

        showLoadingImage();

        callService(
            "POST"
            , `/reservation/customer/reservation/complete?reservationId=${$('#reservationIdModal').val()}`
            , {}
            , function (response) {
                alert(response.message);
                if (response.success) {
                    location.reload();
                }
            }
        );
    });

    function initReservationDetailModal() {
        $('#reservationIdModal').val('');
        $('#consultingMangerIdModal').val('');
        $('#reservationModalPic').text('');
        $('#reservationModalCustomer').text('');
        $('#reservationModalPartner').text('');
        $('#isAlldayModal').prop('checked', false);
        fp1.clear();
        $('#consultingHourModal').val('');
        $('#consultingMinuteModal').val('');
        $('#reservationModalType').val(1);
        $('#reservationModalMemo').val('');
        $('#reservationModalContract').val(0);
    }

    function setReservationDetailInfo(data) {
        $('#reservationIdModal').val(data.reservationId);
        $('#consultingMangerIdModal').val(data.consultingManagerId);
        $('#reservationModalPic').text(data.consultingManagerName);
        $('#reservationModalCustomer').text(data.name1);
        $('#reservationModalPartner').text(data.consultingPartnerName == null ? '' : data.consultingPartnerName);
        $('#isAlldayModal').prop('checked', data.isAllday);
        fp1.setDate(data.consultingDate, true);
        if (!data.isAllday) {
            $('#consultingHourModal').val(data.consultingHour);
            $('#consultingMinuteModal').val(data.consultingMinute);
        }
        setReadonlySelect($('#consultingHourModal'), data.isAllday);
        setReadonlySelect($('#consultingMinuteModal'), data.isAllday);

        $('#reservationModalType').val(data.type);
        $('#reservationModalMemo').val(data.memo);
        $('#reservationModalContract').val(data.contract);
    }
</script>

</html>
